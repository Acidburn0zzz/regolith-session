#!/bin/bash
# This script initializes Regolith Xresources and launches i3.

set -Eeu -o pipefail

# File Locations - Optional User Overrides
USER_XRESOURCE_OVERRIDE_FILE="$HOME/.config/regolith/Xresources"
USER_XRESOURCE_SEARCH_PATH="$HOME/.config/regolith/Xresources.d"

# File Locations - System Defaults
DEFAULT_XRESOURCE_LOOK_FILE="/usr/share/regolith-look/minimal/root"
SYSTEM_XRESOURCE_DIR="/etc/regolith/Xresources.d"
DEFAULT_SYS_I3_CONFIG_FILE="/etc/regolith/i3/config"
DEFAULT_USER_I3_CONFIG_FILE="$HOME/.config/regolith/i3/config"
DEFAULT_SYS_CONFIG_DIR="/etc/regolith/i3/conf.d"

# File Locations - Baseline
BASELINE_XRESOURCE_FILE="$HOME/.Xresources"

# Determine partial or default config modes.
is_partial_mode() {
    # A missing partial config dir means partial mode is off.
    if [ ! -d "$DEFAULT_SYS_CONFIG_DIR" ]; then
        return 1
    fi

    # The existence of an Xresource key/value pair of i3-wm.config.mode: default shall mean that the config partial mode is off. 
    if [ "$(xrescat i3-wm.config.mode)" == "default" ]; then
        return 1
    fi

    # The existence of an Xresource key/value pair of i3-wm.config.mode: partial shall mean that the config partial mode is on.
    if [ "$(xrescat i3-wm.config.mode)" == "partial" ]; then
        return 0
    fi

    # The existence of a file at /etc/regolith/i3/config shall mean that the config partial mode is off
    if [ -f "$DEFAULT_SYS_I3_CONFIG_FILE" ]; then
        return 1
    fi

    # The existence of a file at /etc/regolith/i3/config shall mean that the config partial mode is off. 
    if [ -f "$DEFAULT_USER_I3_CONFIG_FILE" ]; then
        return 1
    else
        return 0 # true
    fi
}

# Determine where the default i3 config file is
# Sets I3_CONFIG_FILE
resolve_default_config_file() {
    if [ -f "$DEFAULT_USER_I3_CONFIG_FILE" ]; then
        I3_CONFIG_FILE="$DEFAULT_USER_I3_CONFIG_FILE"
    else
        I3_CONFIG_FILE="$DEFAULT_SYS_I3_CONFIG_FILE"
    fi
}

# Overwrite an existing file and add header
generate_partial_config_header() {
    SCRIPTPATH="$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"    
    echo "# This config file was generated by $SCRIPTPATH at $(date)" > "$GENERATED_CONFIG_FILE"
    echo "# DO NOT make edits here, they will be lost.  Instead, see [TBD] for details." >> "$GENERATED_CONFIG_FILE"
}

# Launch i3 in default config file
start_i3_default_config_mode() {
    resolve_default_config_file
    echo "Regolith is launching i3-gaps with $I3_CONFIG_FILE"
    echo "i3 -c $I3_CONFIG_FILE"
}

# Launch i3 in partial config file
start_i3_partial_config_mode() {
    I3_PARTIAL_DIR=$DEFAULT_SYS_CONFIG_DIR

    GENERATED_CONFIG_FILE="$HOME/.config/regolith/i3/config-generated"

    generate_partial_config_header

    for filename in "$I3_PARTIAL_DIR"/*; do
        echo "#+ $filename ($(date +%s))" >> "$GENERATED_CONFIG_FILE"
        cat "$filename" >> "$GENERATED_CONFIG_FILE"
    done

    echo "Regolith is launching i3-gaps with $I3_CONFIG_FILE"
    echo "i3 -c $GENERATED_CONFIG_FILE"
}

load_look_xres() {
    LOOK_STYLE_ROOT_PATH=$(xrescat regolith.look.path $DEFAULT_XRESOURCE_LOOK_FILE)

    # Load Regolith Style root Xresource file 
    xrdb -merge "$LOOK_STYLE_ROOT_PATH"
}

load_system_xres() {
    for filename in "$SYSTEM_XRESOURCE_DIR"/*; do
        xrdb -merge "$filename"        
    done
}

# Load default Xresources
load_standard_xres() {    
    if [ -f "$BASELINE_XRESOURCE_FILE" ]; then
        xrdb -merge "$BASELINE_XRESOURCE_FILE"
    fi
}

# Merge user overrides of Xresources if exists
load_user_xres() {
    if [ -f "$USER_XRESOURCE_OVERRIDE_FILE" ]; then
        xrdb -I"$USER_XRESOURCE_SEARCH_PATH" -merge "$USER_XRESOURCE_OVERRIDE_FILE"
    fi
}

# Change the quotes in workspace names from double to to single.
# Due to a limitation of the preprocessor they have double quotes.
# The i3-wm workspace command fails with double quotes in the name
xres_i3_cleanup() {   
    xrdb -query |grep i3-wm.workspace.|sed "s/\"/'/g"|xrdb -merge
}

# --------- Script Main -----------

load_system_xres

load_standard_xres

load_user_xres

load_look_xres

xres_i3_cleanup

# Register with gnome-session so that it does not kill the whole session thinking it is dead.
# See https://zork.net/~st/jottings/gnome-i3.html for details
if [ -n "$DESKTOP_AUTOSTART_ID" ]; then
    dbus-send --print-reply --session --dest=org.gnome.SessionManager "/org/gnome/SessionManager" org.gnome.SessionManager.RegisterClient "string:Regolith" "string:$DESKTOP_AUTOSTART_ID"
fi

if is_partial_mode; then
    start_i3_partial_config_mode
else    
    start_i3_default_config_mode
fi

# Close session when i3 exits.
if [ -n "$DESKTOP_AUTOSTART_ID" ]; then
    dbus-send --print-reply --session --dest=org.gnome.SessionManager "/org/gnome/SessionManager" org.gnome.SessionManager.Logout "uint32:1"
fi
